<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>About Actions | Moleculer</title>
    <meta name="description" content="Progressive microservices framework for Java">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/site/assets/css/styles.styles.b34df04f.css" as="style"><link rel="preload" href="/site/assets/js/app.e0fe1d5c.js" as="script"><link rel="preload" href="/site/assets/js/0.081eba35.js" as="script"><link rel="preload" href="/site/assets/js/4.2389e4ce.js" as="script"><link rel="prefetch" href="/site/assets/js/1.33c39319.js"><link rel="prefetch" href="/site/assets/js/10.97cb87e3.js"><link rel="prefetch" href="/site/assets/js/11.833e01b6.js"><link rel="prefetch" href="/site/assets/js/12.e143bc2b.js"><link rel="prefetch" href="/site/assets/js/13.41f20d28.js"><link rel="prefetch" href="/site/assets/js/14.651bf149.js"><link rel="prefetch" href="/site/assets/js/15.deff7e50.js"><link rel="prefetch" href="/site/assets/js/16.a3446687.js"><link rel="prefetch" href="/site/assets/js/17.4ecb513e.js"><link rel="prefetch" href="/site/assets/js/18.70e198c2.js"><link rel="prefetch" href="/site/assets/js/19.906acddc.js"><link rel="prefetch" href="/site/assets/js/2.8826d7a3.js"><link rel="prefetch" href="/site/assets/js/20.8abfe9f3.js"><link rel="prefetch" href="/site/assets/js/21.46c44dbb.js"><link rel="prefetch" href="/site/assets/js/3.9b4d0edb.js"><link rel="prefetch" href="/site/assets/js/5.2473128d.js"><link rel="prefetch" href="/site/assets/js/6.7c5ea534.js"><link rel="prefetch" href="/site/assets/js/7.29e5d4de.js"><link rel="prefetch" href="/site/assets/js/8.9cda68ff.js"><link rel="prefetch" href="/site/assets/js/9.03084ad8.js">
    <link rel="stylesheet" href="/site/assets/css/styles.styles.b34df04f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><img src="logo.png" alt="Moleculer" class="logo"> <span class="site-name can-hide">Moleculer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/site/broker.html" class="sidebar-link">Service Broker</a></li><li><a href="/site/services.html" class="sidebar-link">Services</a></li><li><a href="/site/lifecycle.html" class="sidebar-link">Lifecycle</a></li><li><a href="/site/actions.html" class="active sidebar-link">Actions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/actions.html#about-actions" class="sidebar-link">About Actions</a></li><li class="sidebar-sub-header"><a href="/site/actions.html#calling-actions" class="sidebar-link">Calling Actions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/actions.html#usages" class="sidebar-link">Usages</a></li><li class="sidebar-sub-header"><a href="/site/actions.html#metadata" class="sidebar-link">Metadata</a></li></ul></li><li class="sidebar-sub-header"><a href="/site/actions.html#streaming" class="sidebar-link">Streaming</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/actions.html#examples" class="sidebar-link">Examples</a></li></ul></li><li class="sidebar-sub-header"><a href="/site/actions.html#context" class="sidebar-link">Context</a></li><li class="sidebar-sub-header"><a href="/site/actions.html#converting-java-annotations-to-platform-independent-properties" class="sidebar-link">Converting Java Annotations to platform-independent properties</a></li></ul></li><li><a href="/site/middlewares.html" class="sidebar-link">Middlewares</a></li><li><a href="/site/caching.html" class="sidebar-link">Caching</a></li><li><a href="/site/events.html" class="sidebar-link">Events</a></li><li><a href="/site/internal-services.html" class="sidebar-link">Internal Services</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Clustering</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="about-actions"><a href="#about-actions" class="header-anchor">#</a> About Actions</h2> <p>Actions are the callable/public methods of the Services.
The action calling represents a remote-procedure-call (RPC).
It has request parameters and returns a response like an HTTP service.</p> <p>If there are multiple instances of Services, the Service Broker
invokes instances according to the specified call strategy.
<a href="/site/balancing.html">Read more about balancing</a>.</p> <div align="center"><img src="action-balancing.gif" alt="Action balancing diagram"></div> <h2 id="calling-actions"><a href="#calling-actions" class="header-anchor">#</a> Calling Actions</h2> <p>To call an Action, use the <code>broker.call</code> method.
The broker looks for the Service (and the node) that has the Action and calls it.
The Action returns a <a href="https://berkesa.github.io/datatree-promise/" target="_blank" rel="noopener noreferrer">Promise<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Promise</span> res <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>actionName<span class="token punctuation">,</span> params<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>actionName</code> is a dot-separated string.
The first part of it is the service name, while the second part of it represents the action name.
So if you have a <code>posts</code> service with a <code>create</code> action, you can call it as <code>posts.create</code>.</p> <p>The <code>params</code> is an object which is passed to the action as a part of the <a href="#Context">Context</a>.
The service can access it via <code>ctx.params</code>.
In the Node.js-based Moleculer implementation, the 'params' is a JavaScript Object.
A JavaScript Object is a collection of named values:</p> <p>Sample JavaScript Object:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>param1<span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span>
              param2<span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">,</span>
              param3<span class="token operator">:</span> <span class="token number">12345678</span><span class="token punctuation">,</span>
              param3<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>There is no similar native support for dynamic creation of JSON objects in Java language.
Because of this, Moleculer uses an
<a href="https://berkesa.github.io/datatree/" target="_blank" rel="noopener noreferrer">abstract API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
instead of a certain JSON implementation.
The <code>Tree</code> object is an <strong>abstract layer</strong> that uses an arbitrary JSON implementation.
Tree API supports 18 popular JSON implementations (eg. Jackson, Gson, Boon, Jodd, FastJson),
and 10 non-JSON data formats (YAML, ION, BSON, MessagePack, etc.).
Besides that Tree API adds manipulation capabilities to the underlaying JSON API,
such as sorting, filtering, merging, cloning, or changing data types.
The specific JSON (or non-JSON) implementation can be configured
in the Moleculer configuration (see in section &quot;Serializer&quot;).</p> <p>The following Java code snippet builds similar JSON structure like the previous JavaScript code:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Tree</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param3&quot;</span><span class="token punctuation">,</span> <span class="token number">12345678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param4&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The following Java statement...</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>... will print this:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;param1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;param2&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;param3&quot;</span> <span class="token operator">:</span> <span class="token number">12345678</span><span class="token punctuation">,</span>
  <span class="token property">&quot;param4&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The last parameter is the <code>opts</code>.
The <code>opts</code> is an CallOptions to set/override some request parameters,
for example <code>timeout</code>, <code>retryCount</code> or <code>nodeID</code>.
CallOptions can be produced using method chainig:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CallOptions</span> opts <span class="token operator">=</span> <span class="token class-name">CallOptions</span><span class="token punctuation">.</span><span class="token function">nodeID</span><span class="token punctuation">(</span><span class="token string">&quot;node-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retryCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Tree</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param3&quot;</span><span class="token punctuation">,</span> <span class="token number">12345678</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param4&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Promise</span> promise <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;service.action&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// The response is also a Tree Object</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Response: &quot;</span> <span class="token operator">+</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// The 'err' is a 'Throwable'</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If the request consists of simple name-value pairs, you do not need to create a Tree object as above.
The name-value pairs can be listed after the &quot;service.action&quot; parameter:</p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;service.action&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param3&quot;</span><span class="token punctuation">,</span> <span class="token number">12345678</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param4&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token class-name">CallOptions</span><span class="token punctuation">.</span><span class="token function">nodeID</span><span class="token punctuation">(</span><span class="token string">&quot;node-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retryCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Response: &quot;</span> <span class="token operator">+</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Available calling options:</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td><code>timeout</code></td> <td><code>Number</code></td> <td><code>null</code></td> <td>Timeout of request in milliseconds. <a href="/site/fault-tolerance.html#Timeout">Read more</a></td></tr> <tr><td><code>retries</code></td> <td><code>Number</code></td> <td><code>null</code></td> <td>Count of retry of request. If the request is timed out or any I/O error occurs, broker will try to call again. <a href="/site/fault-tolerance.html#Retry">Read more</a></td></tr> <tr><td><code>nodeID</code></td> <td><code>String</code></td> <td><code>null</code></td> <td>Target nodeID. If set, it will make a direct call to the given node.</td></tr></tbody></table> <h3 id="usages"><a href="#usages" class="header-anchor">#</a> Usages</h3> <p><strong>Call without params</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;user.list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User list: &quot;</span><span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Call with params</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;user.get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User: &quot;</span><span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Blocking style calling</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Tree</span> rsp <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;user.get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User: &quot;</span><span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Do not block</p> <p>The <code>waitFor</code> is a blocking operation (temporarily pauses the running Thread),
do not use this method unless it is absolutely necessary for something
(eg. for testing).
Preferably <code>then()</code> and <code>catchError()</code> non-blocking methods should be used.
Asynchronous operations can be organized into a Waterfall Sequence using these methods.</p></div> <p><strong>Call with options</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;user.recommendation&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;limit&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token class-name">CallOptions</span><span class="token punctuation">.</span><span class="token function">retryCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User: &quot;</span><span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="metadata"><a href="#metadata" class="header-anchor">#</a> Metadata</h3> <p>The request structure may contain metadata. It can be name-value pairs or any structure.
Unlike the Node.js version, the Java version stores the metadata in <code>params</code>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Tree</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Tree</span> meta <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
meta<span class="token punctuation">.</span><span class="token function">putList</span><span class="token punctuation">(</span><span class="token string">&quot;anArray&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;service.action&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Response: &quot;</span> <span class="token operator">+</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The remote service can access the metadata block with the <code>ctx.params.getMeta()</code> function.
Meta is merged at nested calls:</p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">createService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Action</span> first <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    
        <span class="token comment">// The &quot;_meta&quot; prefix is a shorthand to access meta:</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;test.second&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_meta.b&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Action</span> second <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// Prints: { a: &quot;John&quot;, b: 5 }</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Invoke actions:</span>
<span class="token class-name">Tree</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Tree</span> meta <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;test.first&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Or shorter:</span>
broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;test.first&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_meta.a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>meta</code> is sent back to the caller service.
Use it to send extra meta information back to the caller
(eg. send response headers back to API gateway or set resolved logged in user to metadata).</p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">createService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Action</span> first <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// Modify meta (first time)</span>
        <span class="token class-name">Tree</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;test.second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

            <span class="token comment">// Prints: { a: &quot;John&quot;, b: 5 }</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Action</span> second <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// Modify meta (second time)</span>
        ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Invoke actions:</span>
broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;test.first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="streaming"><a href="#streaming" class="header-anchor">#</a> Streaming</h2> <p>Moleculer-Java supports streams as request <code>params</code> and as response.
This is useful for uploading or downloading large files, or encoding/decoding the content.
This also allows you to transfer media files between services.</p> <h3 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h3> <p><strong>Sending bytes to a service</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;service.action&quot;</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">&quot;some bytes&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">&quot;more bytes&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// Streams must be closed in any case</span>
    stream<span class="token punctuation">.</span><span class="token function">sendClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The receiving Service can handle incoming data in an event-driven manner:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiverService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Action</span> action <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">onPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> err<span class="token punctuation">,</span> close<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Byte-array received </span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// An error occurred</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Stream closed</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Sending a file to a service</strong></p> <p>Please note, the <code>params</code> should be a stream, you cannot add other variables to the <code>params</code>.
Use the <code>meta</code> property to transfer additional data.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Create stream</span>
<span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Write filename into the meta block</span>
<span class="token class-name">Tree</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckedTree</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Tree</span> meta <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;avatar-123.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Open connection</span>
broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;storage.save&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Response received - transfer finished</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start sending data in smaller packages</span>
stream<span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;avatar-123.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Receiving the file at the service's side</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;storage&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StorageService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Action</span> save <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> filename <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Returning a stream as response at the service's side</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StorageService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Action</span> get <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> filename <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stream<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Process received stream at the caller's side</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token string">&quot;avatar-123.jpg&quot;</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;storage.get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// Response received</span>
    <span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PacketStream</span><span class="token punctuation">)</span> rsp<span class="token punctuation">.</span><span class="token function">asObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Receiving file...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>end <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// Saving finished, `transferTo` completed</span>
    <span class="token comment">// the previously returned Promise</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Ok!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// Downloading failed</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="context"><a href="#context" class="header-anchor">#</a> Context</h2> <p>When you call an action, the broker creates a <code>Context</code> instance which contains all request information
and passes it to the action handler as a single argument.</p> <p><strong>Available properties &amp; methods of the <code>Context</code>:</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>ctx.id</code></td> <td><code>String</code></td> <td>Unique context ID</td></tr> <tr><td><code>ctx.name</code></td> <td><code>String</code></td> <td>Action name (in &quot;service.action&quot; format)</td></tr> <tr><td><code>ctx.requestID</code></td> <td><code>String</code></td> <td>Request ID. If you make nested-calls, it will be the same ID</td></tr> <tr><td><code>ctx.parentID</code></td> <td><code>String</code></td> <td>Parent context ID (in nested-calls)</td></tr> <tr><td><code>ctx.params</code></td> <td><code>Tree</code></td> <td>Request params including metadata (second argument from <code>broker.call</code>)</td></tr> <tr><td><code>ctx.stream</code></td> <td><code>PacketStream</code></td> <td>Request stream or <code>null</code></td></tr> <tr><td><code>ctx.level</code></td> <td><code>int</code></td> <td>Request level (in nested-calls, the first level is <code>1</code>)</td></tr> <tr><td><code>ctx.startTime</code></td> <td><code>long</code></td> <td>Timestamp of the context creation</td></tr> <tr><td><code>ctx.call()</code></td> <td><code>Method</code></td> <td>Make nested-calls (same arguments like in <code>broker.call</code>)</td></tr> <tr><td><code>ctx.emit()</code></td> <td><code>Method</code></td> <td>Emit an event (same as <code>broker.emit</code>)</td></tr> <tr><td><code>ctx.broadcast()</code></td> <td><code>Method</code></td> <td>Broadcast an event (same as <code>broker.broadcast</code>)</td></tr></tbody></table> <h2 id="converting-java-annotations-to-platform-independent-properties"><a href="#converting-java-annotations-to-platform-independent-properties" class="header-anchor">#</a> Converting Java Annotations to platform-independent properties</h2> <p>ServiceBroker converts Java Annotations of Actions into JSON format,
therefore, they can be parsed on remote nodes.
The programming language doesn't matter, such as those available on JavaScript based nodes.
These properties are passed on as the service is discovered.</p> <p>It is advisable to process these properties using (Java or JavaScipt-based)
<a href="/site/middlewares.html">Middlewares</a>, and based on the values of the properties,
Middlewares may change the way the services work.</p> <p>The following example shows three types of Annotation conversions.
The first one (the <code>@Deprecated</code>) is an Annotation without parameters.
Such Annotations are passed as logical values with a &quot;true&quot; value.
The second Annotation (the <code>@SingleValue</code>) can have only one value.
Such Annotations are passed as a key-value pair.
The third Annotation (the <code>@MultiValue</code>) contains more values.
Such Annotations are converted into a JSON structures by the ServiceBroker.
It is important to note that only Annotations with a <code>RetentionPolicy</code> value of <code>RUNTIME</code>
will be available in the Service Descriptor
(for example, <code>@SuppressWarnings</code> is not visible on remote nodes
because it exists only at the source level).</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token annotation punctuation">@SingleValue</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@MultiValue</span><span class="token punctuation">(</span>key1<span class="token operator">:</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> key2<span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">)</span>
    <span class="token class-name">Action</span> action <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>Generated service description, also available on remote nodes:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;service.action&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service.action&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deprecated&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;singleValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;multiValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;key1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;key2&quot;</span><span class="token operator">:</span> <span class="token number">123</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The Service Descriptor is received by all remote nodes and can be processed,
regardless of the programming language.
Sample Middleware that checks the configuration of a Java (or JavaScript) Action:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeprecationChecker</span> <span class="token keyword">extends</span> <span class="token class-name">Middleware</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Action</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">Action</span> action<span class="token punctuation">,</span> <span class="token class-name">Tree</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// Get value of the property (false = default value)</span>
        <span class="token keyword">boolean</span> deprecated <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;deprecated&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Print warning if the Action is deprecated </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deprecated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; action is deprecated!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To install the above Middleware, call the ServiceBroker <code>use</code> function:</p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeprecationChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/site/lifecycle.html" class="prev">Lifecycle</a></span> <span class="next"><a href="/site/middlewares.html">Middlewares</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/site/assets/js/app.e0fe1d5c.js" defer></script><script src="/site/assets/js/0.081eba35.js" defer></script><script src="/site/assets/js/4.2389e4ce.js" defer></script>
  </body>
</html>
