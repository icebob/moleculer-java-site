<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Middlewares | Moleculer</title>
    <meta name="description" content="Progressive microservices framework for Java">
    
    
    <link rel="preload" href="/site/assets/css/0.styles.75e38820.css" as="style"><link rel="preload" href="/site/assets/js/app.9acef152.js" as="script"><link rel="preload" href="/site/assets/js/2.ee67e98b.js" as="script"><link rel="preload" href="/site/assets/js/20.ef5ec2cf.js" as="script"><link rel="prefetch" href="/site/assets/js/10.0c51408a.js"><link rel="prefetch" href="/site/assets/js/11.35085d4f.js"><link rel="prefetch" href="/site/assets/js/12.b8887cbf.js"><link rel="prefetch" href="/site/assets/js/13.e6912905.js"><link rel="prefetch" href="/site/assets/js/14.f89c1874.js"><link rel="prefetch" href="/site/assets/js/15.96da9083.js"><link rel="prefetch" href="/site/assets/js/16.64b959d6.js"><link rel="prefetch" href="/site/assets/js/17.00bde7ec.js"><link rel="prefetch" href="/site/assets/js/18.226004fa.js"><link rel="prefetch" href="/site/assets/js/19.ae18779b.js"><link rel="prefetch" href="/site/assets/js/21.3e703e8e.js"><link rel="prefetch" href="/site/assets/js/22.9497ca52.js"><link rel="prefetch" href="/site/assets/js/23.62b579e2.js"><link rel="prefetch" href="/site/assets/js/24.b704a915.js"><link rel="prefetch" href="/site/assets/js/25.8ed0f3cc.js"><link rel="prefetch" href="/site/assets/js/26.2c732a20.js"><link rel="prefetch" href="/site/assets/js/27.d61b2d89.js"><link rel="prefetch" href="/site/assets/js/3.f084eaa4.js"><link rel="prefetch" href="/site/assets/js/4.a02ade56.js"><link rel="prefetch" href="/site/assets/js/5.357c372d.js"><link rel="prefetch" href="/site/assets/js/6.ce997fe8.js"><link rel="prefetch" href="/site/assets/js/7.d678ff04.js"><link rel="prefetch" href="/site/assets/js/8.67823e67.js"><link rel="prefetch" href="/site/assets/js/9.dfda2b92.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.75e38820.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><!----> <span class="site-name">Moleculer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div><div class="nav-item"><a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div><div class="nav-item"><a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/site/broker.html" class="sidebar-link">Service Broker</a></li><li><a href="/site/services.html" class="sidebar-link">Services</a></li><li><a href="/site/lifecycle.html" class="sidebar-link">Lifecycle</a></li><li><a href="/site/actions.html" class="sidebar-link">Actions</a></li><li><a href="/site/middlewares.html" class="active sidebar-link">Middlewares</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/middlewares.html#complete-list" class="sidebar-link">Complete List</a></li><li class="sidebar-sub-header"><a href="/site/middlewares.html#wrapping-handlers" class="sidebar-link">Wrapping handlers</a></li><li class="sidebar-sub-header"><a href="/site/middlewares.html#internal-middlewares" class="sidebar-link">Internal middlewares</a></li><li class="sidebar-sub-header"><a href="/site/middlewares.html#global-view" class="sidebar-link">Global view</a></li></ul></li><li><a href="/site/caching.html" class="sidebar-link">Caching</a></li><li><a href="/site/events.html" class="sidebar-link">Events</a></li><li><a href="/site/internal-services.html" class="sidebar-link">Internal Services</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Clustering</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Moleculer supports middlewares. The middleware is an <code>Object</code> with hooks &amp; wrapper functions. It allows to wrap action handlers, event handlers, broker methods and hook lifecycle events.</p> <h2 id="complete-list"><a href="#complete-list" class="header-anchor">#</a> Complete List</h2> <p><strong>All available methods:</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> <span class="token class-name">MyCustomMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// Wrap local action handlers (legacy middleware handler)</span>
    <span class="token function">localAction</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Change context properties or something</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do something with the response</span>
                    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Handle error or throw further</span>
                    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap remote action calling</span>
    <span class="token function">remoteAction</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Change context properties or something</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do something with the response</span>
                    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Handle error or throw further</span>
                    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap local event handlers</span>
    <span class="token function">localEvent</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.createService method</span>
    <span class="token function">createService</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> schemaMods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'createService' is called.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> schemaMods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.destroyService method</span>
    <span class="token function">destroyService</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'destroyService' is called.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.call method</span>
    <span class="token function">call</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>actionName<span class="token punctuation">,</span> params<span class="token punctuation">,</span> opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'call' is called.&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>actionName<span class="token punctuation">,</span> params<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Response:&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.mcall method</span>
    <span class="token function">mcall</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'call' is called.&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Response:&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.emit method</span>
    <span class="token function">emit</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'emit' is called.&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.broadcast method</span>
    <span class="token function">broadcast</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'broadcast' is called.&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Wrap broker.broadcastLocal method</span>
    <span class="token function">broadcastLocal</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The 'broadcastLocal' is called.&quot;</span><span class="token punctuation">,</span> eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After a new local service created (sync)</span>
    <span class="token function">serviceCreated</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service created&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Before a local service started (async)</span>
    <span class="token function">serviceStarting</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service is starting&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After a local service started (async)</span>
    <span class="token function">serviceStarted</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service started&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Before a local service stopping (async)</span>
    <span class="token function">serviceStopping</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service is stopping&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After a local service stopped (async)</span>
    <span class="token function">serviceStopped</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service stopped&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called before registering a local service instance</span>
    <span class="token function">registerLocalService</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Registering local services&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called during local service creation (after mixins are applied, i.e, service schema is merged completely)</span>
    <span class="token function">serviceCreating</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> schema<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Modify schema</span>
        schema<span class="token punctuation">.</span>myProp <span class="token operator">=</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called before sending a communication packet</span>
    <span class="token function">transitPublish</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>packet<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called before transit receives &amp; parses an incoming message</span>
    <span class="token function">transitMessageHandler</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> packet<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called after serialization but before the transporter sends a communication packet</span>
    <span class="token function">transporterSend</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>topic<span class="token punctuation">,</span> data<span class="token punctuation">,</span> meta<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// Do something with data</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> data<span class="token punctuation">,</span> meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Called after transporter received a communication packet but before serialization</span>
    <span class="token function">transporterReceive</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> data<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// Do something with data</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> data<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After broker is created (async)</span>
    <span class="token function">created</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Broker created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Before broker starting (async)</span>
    <span class="token function">starting</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Broker is starting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After broker started (async)</span>
    <span class="token function">started</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Broker started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Before broker stopping (async)</span>
    <span class="token function">stopping</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Broker is stopping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// After broker stopped (async)</span>
    <span class="token function">stopped</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Broker stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="wrapping-handlers"><a href="#wrapping-handlers" class="header-anchor">#</a> Wrapping handlers</h2> <p>Some hooks are wrappers. It means you must wrap the original handler and return a new Function.
Wrap hooks where the first parameter is <code>next</code>.</p> <p><strong>Wrap local action handler</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> <span class="token class-name">MyDoSomethingMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">localAction</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>myFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Wrap the handler</span>
            <span class="token keyword">return</span> <span class="token function">function</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">doSomethingBeforeHandler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                        <span class="token function">doSomethingAfterHandler</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Return the original result</span>
                        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                        <span class="token function">doSomethingAfterHandlerIfFailed</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// Throw further the error</span>
                        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the feature is disabled we don't wrap it, return the original handler</span>
        <span class="token comment">// So it won't cut down the performance at calling where the feature is disabled.</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Example validator middleware</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> <span class="token class-name">MyValidator</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">localAction</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Wrap with a param validator if `action.params` is defined</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ctx <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>params<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>next</code> is the original handler or the following wrapped handler. The middleware should return either the original <code>handler</code> or a new wrapped handler. As you can see above, the middleware checks whether the action has a <code>params</code> property. If yes, it will return a wrapped handler which calls the validator module before calling the original <code>handler</code>. If the <code>params</code> property is not defined, it simply returns the original <code>handler</code> (skipped wrapping).</p> <blockquote><p>If you don't call the original <code>next</code> in the middleware it will break the request. It can be used in cachers. For example, if it finds the requested data in the cache, it'll return the cached data instead of calling the <code>next</code>.</p></blockquote> <p><strong>Example cacher middleware</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> <span class="token class-name">MyCacher</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">localAction</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> function <span class="token function">cacherMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">,</span> action<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Found in the cache! Don't call next, return with the cached content</span>
                ctx<span class="token punctuation">.</span>cachedResult <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Call the next</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Afterwards save the response to the cache</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>The <code>next</code> always returns a <code>Promise</code>. So you can access to responses and manipulate them, as well.</p></blockquote> <h3 id="decorate-core-modules-extend-functionality"><a href="#decorate-core-modules-extend-functionality" class="header-anchor">#</a> Decorate core modules (extend functionality)</h3> <p>Middleware functions can be used to add new features to <code>ServiceBroker</code> &amp; <code>Service</code>.</p> <p><strong>Decorate broker with a new <code>allCall</code> method</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// After broker is created</span>
            <span class="token function">created</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Call action on all available nodes</span>
                broker<span class="token punctuation">.</span>allCall <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> params<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> nodeIDs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">getNodeList</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onlyAvailable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>node <span class="token operator">=</span><span class="token operator">&gt;</span> node<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Make direct call to the given Node ID</span>
                    <span class="token keyword">return</span> <span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>nodeIDs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>nodeID <span class="token operator">=</span><span class="token operator">&gt;</span> broker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeID <span class="token punctuation">}</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

await broker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call `$node.health` on every nodes &amp; collect results</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> await broker<span class="token punctuation">.</span><span class="token function">allCall</span><span class="token punctuation">(</span><span class="token string">&quot;$node.health&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="internal-middlewares"><a href="#internal-middlewares" class="header-anchor">#</a> Internal middlewares</h2> <p>Many integrated features have been exposed as internal middlewares. These middlewares are loaded by default when broker is created. However, they can be turned off by setting the <code>internalMiddlewares: false</code> in broker option. In this case you must explicitly specify the required middlewares in the <code>middlewares: []</code> broker option.</p> <p><strong>Internal middlewares</strong></p> <table><thead><tr><th>Class name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>ActionHook</code></td> <td>Optional</td> <td>Action hooks handler. <a href="/site/actions.html#Action-hooks">Read more</a></td></tr> <tr><td><code>Cacher</code></td> <td>Optional</td> <td>Cacher middleware. <a href="/site/caching.html">Read more</a></td></tr> <tr><td><code>ContextTracker</code></td> <td>Optional</td> <td>Context tracker feature. <a href="/site/actions.html#Context-tracking">Read more</a></td></tr> <tr><td><code>CircuitBreaker</code></td> <td>Optional</td> <td>Circuit Breaker feature. <a href="/site/fault-tolerance.html#Circuit-Breaker">Read more</a></td></tr> <tr><td><code>Timeout</code></td> <td>Always</td> <td>Timeout feature. <a href="/site/fault-tolerance.html#Timeout">Read more</a></td></tr> <tr><td><code>Retry</code></td> <td>Always</td> <td>Retry feature. <a href="/site/fault-tolerance.html#Retry">Read more</a></td></tr> <tr><td><code>Fallback</code></td> <td>Always</td> <td>Fallback feature. <a href="/site/fault-tolerance.html#Fallback">Read more</a></td></tr> <tr><td><code>ErrorHandler</code></td> <td>Always</td> <td>Error handling.</td></tr> <tr><td><code>Metrics</code></td> <td>Optional</td> <td>Metrics feature. <a href="/site/metrics.html">Read more</a></td></tr> <tr><td><code>Transmit.Encryption</code></td> <td>Optional</td> <td>Transmission encryption middleware. <a href="#Encryption">Read more</a></td></tr> <tr><td><code>Transmit.Compression</code></td> <td>Optional</td> <td>Transmission compression middleware. <a href="#Compression">Read more</a></td></tr> <tr><td><code>Debugging.TransitLogger</code></td> <td>Optional</td> <td>Transit Logger. <a href="#Transit-Logger">Read more</a></td></tr> <tr><td><code>Debugging.ActionLogger</code></td> <td>Optional</td> <td>Action logger. <a href="#Action-Logger">Read more</a></td></tr></tbody></table> <p><strong>Access to internal middlewares</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token class-name">Bulkhead</span><span class="token punctuation">,</span> <span class="token class-name">Retry</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token class-name">Middlewares</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="transmission-middleware"><a href="#transmission-middleware" class="header-anchor">#</a> Transmission Middleware</h3> <h4 id="encryption"><a href="#encryption" class="header-anchor">#</a> Encryption</h4> <p>AES encryption middleware protects all inter-services communications that use the transporter module.
This middleware uses built-in Node <a href="https://nodejs.org/api/crypto.html" target="_blank" rel="noopener noreferrer"><code>crypto</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> lib.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create broker</span>
<span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Transmit<span class="token punctuation">.</span><span class="token function">Encryption</span><span class="token punctuation">(</span><span class="token string">&quot;secret-password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;aes-256-cbc&quot;</span><span class="token punctuation">,</span> initVector<span class="token punctuation">)</span> <span class="token comment">// &quot;aes-256-cbc&quot; is the default</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="compression"><a href="#compression" class="header-anchor">#</a> Compression</h4> <p>Compression middleware reduces the size of the messages that go through the transporter module.
This middleware uses built-in Node <a href="https://nodejs.org/api/zlib.html" target="_blank" rel="noopener noreferrer"><code>zlib</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> lib.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create broker</span>
<span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Transmit<span class="token punctuation">.</span><span class="token function">Compression</span><span class="token punctuation">(</span><span class="token string">&quot;deflate&quot;</span><span class="token punctuation">)</span> <span class="token comment">// or &quot;deflateRaw&quot; or &quot;gzip&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="debug-middleware"><a href="#debug-middleware" class="header-anchor">#</a> Debug Middleware</h3> <h4 id="transit-logger"><a href="#transit-logger" class="header-anchor">#</a> Transit Logger</h4> <p>Transit logger middleware allows to easily track the messages that are exchanged between services.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create broker</span>
<span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Debugging<span class="token punctuation">.</span><span class="token function">TransitLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      logPacketData<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      folder<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      colors<span class="token operator">:</span> <span class="token punctuation">{</span>
        send<span class="token operator">:</span> <span class="token string">&quot;magenta&quot;</span><span class="token punctuation">,</span>
        receive<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      packetFilter<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;HEARTBEAT&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Complete option list</strong></p> <table><thead><tr><th>Class name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td><code>logger</code></td> <td><code>Object</code> or <code>Function</code></td> <td><code>null</code></td> <td>Logger class. <a href="/site/logging.html">Read more</a>.</td></tr> <tr><td><code>logLevel</code></td> <td><code>String</code></td> <td><code>info</code></td> <td>Log level for built-in console logger. <a href="/site/logging.html">Read more</a>.</td></tr> <tr><td><code>logPacketData</code></td> <td><code>Boolean</code></td> <td><code>false</code></td> <td>Logs packet parameters</td></tr> <tr><td><code>folder</code></td> <td><code>Object</code></td> <td><code>null</code></td> <td>Path do folder where logs will be written</td></tr> <tr><td><code>extension</code></td> <td><code>String</code></td> <td><code>.json</code>,</td> <td>File extension of log file</td></tr> <tr><td><code>color.receive</code></td> <td><code>String</code></td> <td><code>grey</code></td> <td>Supports all <a href="https://github.com/chalk/chalk#colors" target="_blank" rel="noopener noreferrer">Chalk colors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td><code>color.send</code></td> <td><code>String</code></td> <td><code>grey</code></td> <td>Supports all <a href="https://github.com/chalk/chalk#colors" target="_blank" rel="noopener noreferrer">Chalk colors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td><code>packetFilter</code></td> <td><code>Array&lt;String&gt;</code></td> <td><code>HEARTBEAT</code></td> <td>Type of <a href="/site/protocol.html#Packets">packets</a> to log</td></tr></tbody></table> <h4 id="action-logger"><a href="#action-logger" class="header-anchor">#</a> Action Logger</h4> <p>Action Logger middleware tracks &quot;how&quot; service actions were executed.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create broker</span>
<span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Debugging<span class="token punctuation">.</span><span class="token function">ActionLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      logParams<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      logResponse<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      folder<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      colors<span class="token operator">:</span> <span class="token punctuation">{</span>
        send<span class="token operator">:</span> <span class="token string">&quot;magenta&quot;</span><span class="token punctuation">,</span>
        receive<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      whitelist<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;**&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>Complete option list</strong></p> <table><thead><tr><th>Class name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td><code>logger</code></td> <td><code>Object</code> or <code>Function</code></td> <td><code>null</code></td> <td>Logger class. <a href="/site/logging.html">Read more</a>.</td></tr> <tr><td><code>logLevel</code></td> <td><code>String</code></td> <td><code>info</code></td> <td>Log level for built-in console logger. <a href="/site/logging.html">Read more</a>.</td></tr> <tr><td><code>logParams</code></td> <td><code>Boolean</code></td> <td><code>false</code></td> <td>Logs request parameters</td></tr> <tr><td><code>logMeta</code></td> <td><code>Boolean</code></td> <td><code>false</code></td> <td>Logs meta parameters</td></tr> <tr><td><code>folder</code></td> <td><code>String</code></td> <td><code>null</code></td> <td>Path do folder where logs will be written</td></tr> <tr><td><code>extension</code></td> <td><code>String</code></td> <td><code>.json</code>,</td> <td>File extension of log file</td></tr> <tr><td><code>color.request</code></td> <td><code>String</code></td> <td><code>yellow</code></td> <td>Supports all <a href="https://github.com/chalk/chalk#colors" target="_blank" rel="noopener noreferrer">Chalk colors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td><code>color.response</code></td> <td><code>String</code></td> <td><code>cyan</code></td> <td>Supports all <a href="https://github.com/chalk/chalk#colors" target="_blank" rel="noopener noreferrer">Chalk colors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td><code>colors.error</code></td> <td><code>String</code></td> <td><code>red</code></td> <td>Supports all <a href="https://github.com/chalk/chalk#colors" target="_blank" rel="noopener noreferrer">Chalk colors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td><code>whitelist</code></td> <td><code>Array&lt;String&gt;</code></td> <td><code>**</code></td> <td>Actions to log. Uses the same whitelisting mechanism as in <a href="/site/moleculer-web.html#Whitelist">API Gateway</a>.</td></tr></tbody></table> <h3 id="loading-extending"><a href="#loading-extending" class="header-anchor">#</a> Loading &amp; Extending</h3> <p>If you want to use the built-in middlewares use their names in <code>middlewares[]</code> option. Also, the middleware object can be easily extended with custom functions.</p> <p><strong>Load middleware by name</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moleculer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Extend with custom middleware</span>
    Middlewares<span class="token punctuation">.</span>MyCustom <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">created</span><span class="token punctuation">(</span><span class="token parameter">broker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            broker<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;My custom middleware is created!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>


    <span class="token keyword">const</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        logger<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// Load middleware by name</span>
            <span class="token string">&quot;MyCustom&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><h2 id="global-view"><a href="#global-view" class="header-anchor">#</a> Global view</h2> <div align="center"><img src="assets/middlewares.svg" alt="Middlewares diagram"></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/site/actions.html" class="prev">Actions</a></span> <span class="next"><a href="/site/caching.html">Caching</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/site/assets/js/app.9acef152.js" defer></script><script src="/site/assets/js/2.ee67e98b.js" defer></script><script src="/site/assets/js/20.ef5ec2cf.js" defer></script>
  </body>
</html>
