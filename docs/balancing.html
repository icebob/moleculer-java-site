<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>About load balancing | Moleculer</title>
    <meta name="description" content="Progressive microservices framework for Java">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/site/assets/css/0.styles.f35a1954.css" as="style"><link rel="preload" href="/site/assets/js/app.44cd5f5e.js" as="script"><link rel="preload" href="/site/assets/js/2.b39afa1e.js" as="script"><link rel="preload" href="/site/assets/js/7.2ec3348e.js" as="script"><link rel="prefetch" href="/site/assets/js/10.3d8f7cb4.js"><link rel="prefetch" href="/site/assets/js/11.3ea3085b.js"><link rel="prefetch" href="/site/assets/js/12.02aabf7d.js"><link rel="prefetch" href="/site/assets/js/13.6c5a5be1.js"><link rel="prefetch" href="/site/assets/js/14.b96b9524.js"><link rel="prefetch" href="/site/assets/js/15.719a576a.js"><link rel="prefetch" href="/site/assets/js/16.b54b5939.js"><link rel="prefetch" href="/site/assets/js/17.63f39932.js"><link rel="prefetch" href="/site/assets/js/18.7986bdaa.js"><link rel="prefetch" href="/site/assets/js/19.54db1eb9.js"><link rel="prefetch" href="/site/assets/js/20.aca4251c.js"><link rel="prefetch" href="/site/assets/js/21.7b943fea.js"><link rel="prefetch" href="/site/assets/js/22.baf3db37.js"><link rel="prefetch" href="/site/assets/js/23.48ee59cf.js"><link rel="prefetch" href="/site/assets/js/24.dcfe8fa4.js"><link rel="prefetch" href="/site/assets/js/25.991459d5.js"><link rel="prefetch" href="/site/assets/js/26.dcebd387.js"><link rel="prefetch" href="/site/assets/js/27.f09918ca.js"><link rel="prefetch" href="/site/assets/js/28.f634c817.js"><link rel="prefetch" href="/site/assets/js/29.2d4217a8.js"><link rel="prefetch" href="/site/assets/js/3.b78c1751.js"><link rel="prefetch" href="/site/assets/js/4.3e9b503d.js"><link rel="prefetch" href="/site/assets/js/5.51cf4fa4.js"><link rel="prefetch" href="/site/assets/js/6.3b8f5b4e.js"><link rel="prefetch" href="/site/assets/js/8.3c77073e.js"><link rel="prefetch" href="/site/assets/js/9.e47a2a91.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.f35a1954.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><img src="logo.png" alt="Moleculer" class="logo"> <span class="site-name can-hide">Moleculer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div><div class="nav-item"><a href="https://www.patreon.com/berkesa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Donate
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div><div class="nav-item"><a href="https://www.patreon.com/berkesa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Donate
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Moleculer core</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Clustering</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/site/transporters.html" class="sidebar-link">Transporters</a></li><li><a href="/site/serializers.html" class="sidebar-link">Serializers</a></li><li><a href="/site/balancing.html" class="active sidebar-link">Load balancing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/balancing.html#about-load-balancing" class="sidebar-link">About load balancing</a></li><li class="sidebar-sub-header"><a href="/site/balancing.html#built-in-strategies" class="sidebar-link">Built-in Strategies</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/balancing.html#round-robin-strategy" class="sidebar-link">Round-Robin Strategy</a></li><li class="sidebar-sub-header"><a href="/site/balancing.html#random-strategies" class="sidebar-link">Random Strategies</a></li><li class="sidebar-sub-header"><a href="/site/balancing.html#cpu-usage-based-strategy" class="sidebar-link">CPU usage-based Strategy</a></li><li class="sidebar-sub-header"><a href="/site/balancing.html#latency-based-strategy" class="sidebar-link">Latency-based Strategy</a></li><li class="sidebar-sub-header"><a href="/site/balancing.html#sharding-strategy" class="sidebar-link">Sharding Strategy</a></li></ul></li><li class="sidebar-sub-header"><a href="/site/balancing.html#custom-strategy" class="sidebar-link">Custom Strategy</a></li></ul></li><li><a href="/site/fault-tolerance.html" class="sidebar-link">Fault tolerance</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="about-load-balancing"><a href="#about-load-balancing" class="header-anchor">#</a> About load balancing</h2> <p>Moleculer has several built-in load balancing strategies.
If a <code>Service</code> has <strong>multiple running instances</strong>,
<code>ServiceRegistry</code> uses these strategies to select a node from all available nodes.
The default (pre-set) invocation mode is the <code>RoundRobinStrategy</code>.</p> <div align="center"><img src="action-balancing.gif" alt="Action balancing diagram"></div> <h2 id="built-in-strategies"><a href="#built-in-strategies" class="header-anchor">#</a> Built-in Strategies</h2> <p>To configure <code>Strategy</code>, set &quot;strategy()&quot; builder option when creating the <code>ServiceBroker</code>.
Alternatively, set up the <code>Strategy</code> of the <code>ServiceBrokerConfig</code> using the &quot;setStrategyFactory()&quot; method.</p> <p><strong>Configure a balancing Strategy</strong></p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token comment">// Create a &quot;StrategyFactory&quot;</span>
<span class="token class-name">StrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XorShiftRandomStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Method #1: Setup using ServiceBrokerConfig</span>
<span class="token class-name">ServiceBrokerConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">setStrategyFactory</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Method #2: Setup using ServiceBroker.builder()</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="round-robin-strategy"><a href="#round-robin-strategy" class="header-anchor">#</a> Round-Robin Strategy</h3> <p><img src="https://img.shields.io/badge/Node.js-Compatible-brightgreen.svg" alt=""><br>
This Strategy selects a node based on <a href="https://en.wikipedia.org/wiki/Round-robin_DNS" target="_blank" rel="noopener noreferrer">round-robin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm.
This is the default invocation <code>Strategy</code>.
You can use the &quot;setPreferLocal&quot; function to configure <code>ServiceRegistry</code>
to invoke locally available services whenever they are available in the JVM.
If set to &quot;true&quot;, <code>ServiceBroker</code> will always use internal <code>Action</code> calls, if possible.
Such a function exists for each <code>StrategyFactory</code>.</p> <p><strong>Usage</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RoundRobinStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setPreferLocal</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="random-strategies"><a href="#random-strategies" class="header-anchor">#</a> Random Strategies</h3> <p><img src="https://img.shields.io/badge/Node.js-Compatible-brightgreen.svg" alt=""><br>
These strategies randomly select the callable node.
The load on each node (as in round-robin) will be roughly the same.</p> <p><strong>Usage</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Faster pseudo random</span>
<span class="token class-name">XorShiftRandomStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XorShiftRandomStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Slower secure random</span>
<span class="token class-name">SecureRandomStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandomStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="cpu-usage-based-strategy"><a href="#cpu-usage-based-strategy" class="header-anchor">#</a> CPU usage-based Strategy</h3> <p><img src="https://img.shields.io/badge/Node.js-Compatible-brightgreen.svg" alt=""><br>
This <code>Strategy</code> selects a node which has the lowest CPU usage.
Due to the node list can be very long,
it gets samples and selects the node with the lowest CPU usage from only samples instead of the whole node list.
CPU-based load balancing works even when the application is heterogeneous (consisting of Java and Node.js modules).</p> <p><strong>Usage</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Create CPU monitor</span>
<span class="token class-name">SigarMonitor</span> cpuMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SigarMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create CPU-based strategy</span>
<span class="token class-name">CpuUsageStrategyFactory</span> invocationStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CpuUsageStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
invocationStrategy<span class="token punctuation">.</span><span class="token function">setLowCpuUsage</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
invocationStrategy<span class="token punctuation">.</span><span class="token function">setMaxTries</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create service broker</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>invocationStrategy<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span>cpuMonitor<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
</code></pre></div><p>To determine CPU usage, <code>ServiceBroker</code> needs a <code>Monitor</code> instance that can query the current CPU usage.
Such <code>Monitor</code> is the <code>SigarMonitor</code> based on the <a href="https://github.com/hyperic/sigar" target="_blank" rel="noopener noreferrer">Sigar API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
It requires the presence of <a href="https://mvnrepository.com/artifact/org.hyperic/sigar/1.6.4" target="_blank" rel="noopener noreferrer">JAR files for the Sigar API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in the Java classpath.
It is also necessary to copy the <a href="https://github.com/hyperic/sigar/wiki/binaries" target="_blank" rel="noopener noreferrer">native Sigar binaries<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> into the &quot;java.library.path&quot; directory.
Using the Sigar API is optional; if it not found on the classpath, <code>ServiceBroker</code> will automatically use the <strong>JMX-based</strong> CPU monitor.</p> <p><strong>Strategy options</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td>sampleCount</td> <td>int</td> <td>3</td> <td>The number of samples. The minimum value is 1 (you can't turn off sampling).</td></tr> <tr><td>lowCpuUsage</td> <td>int</td> <td>10</td> <td>The low CPU usage percent (%). The node which has lower CPU usage than this value is selected immediately.</td></tr></tbody></table> <h3 id="latency-based-strategy"><a href="#latency-based-strategy" class="header-anchor">#</a> Latency-based Strategy</h3> <p><img src="https://img.shields.io/badge/Node.js-Compatible-brightgreen.svg" alt=""><br>
This <code>Strategy</code> selects a node which has the lowest latency, measured by periodic ping commands.
<code>NetworkLatencyStrategy</code> will ping each node one by one.
Due to slow sampling, it may take a few minutes for the <code>Services</code> to select optimal nodes.</p> <p><strong>Usage</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Create latency-based strategy</span>
<span class="token class-name">NetworkLatencyStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkLatencyStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setSampleCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setCollectCount</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setPingInterval</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setPingTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create service broker</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Strategy options</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td>sampleCount</td> <td>int</td> <td>5</td> <td>The number of samples. If you have a lot of hosts/nodes, it's recommended to <em>increase</em> the value. Minimum value is &quot;1&quot;.</td></tr> <tr><td>collectCount</td> <td>int</td> <td>5</td> <td>The number of measured latency per host to keep in order to calculate the average latency.</td></tr> <tr><td>pingInterval</td> <td>int</td> <td>10</td> <td>Ping interval in SECONDS. If you have a lot of host/nodes, it's recommended to <em>increase</em> the value.</td></tr> <tr><td>pingTimeout</td> <td>long</td> <td>5000</td> <td>Ping timeout time, in MILLISECONDS.</td></tr></tbody></table> <h3 id="sharding-strategy"><a href="#sharding-strategy" class="header-anchor">#</a> Sharding Strategy</h3> <p><img src="https://img.shields.io/badge/Node.js-Compatible-brightgreen.svg" alt=""><br>
Shard invocation <code>Strategy</code> is based on <a href="https://www.toptal.com/big-data/consistent-hashing" target="_blank" rel="noopener noreferrer">consistent-hashing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm.
It uses a key value from context &quot;params&quot; or &quot;meta&quot; to route the request to nodes.
It means that requests with same key value will be routed to the same node.</p> <p><strong>Usage</strong></p> <p>Shard key is &quot;name&quot; in context params :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Create sharding strategy</span>
<span class="token class-name">ShardStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setShardKey</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create service broker</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Shard key is user.id in context meta :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ShardStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
strategy<span class="token punctuation">.</span><span class="token function">setShardKey</span><span class="token punctuation">(</span><span class="token string">&quot;#user.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If shard key is in context's &quot;meta&quot; it must be declared with a &quot;#&quot; at the beginning.
The actual &quot;#&quot; is ignored.</p></div> <p><strong>Strategy options</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td>shardKey</td> <td>String</td> <td>null</td> <td>Shard key</td></tr> <tr><td>vnodes</td> <td>int</td> <td>10</td> <td>Number of virtual nodes</td></tr> <tr><td>ringSize</td> <td>Integer</td> <td>null</td> <td>Size of the ring</td></tr> <tr><td>cacheSize</td> <td>int</td> <td>1024</td> <td>Size of the cache</td></tr></tbody></table> <h2 id="custom-strategy"><a href="#custom-strategy" class="header-anchor">#</a> Custom Strategy</h2> <p>Custom <code>Strategy</code> can be created by implementing <code>StrategyFactory</code> and <code>Strategy</code> interfaces.
We recommend to copy the source of <a href="https://github.com/moleculer-java/moleculer-java/blob/master/src/main/java/services/moleculer/strategy/SecureRandomStrategyFactory.java" target="_blank" rel="noopener noreferrer">SecureRandomStrategyFactory<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
and <a href="https://github.com/moleculer-java/moleculer-java/blob/master/src/main/java/services/moleculer/strategy/SecureRandomStrategy.java" target="_blank" rel="noopener noreferrer">SecureRandomStrategy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
classes, and modify the &quot;next()&quot; method in the &quot;SecureRandomStrategy.java&quot;.</p> <p><strong>Usage</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MyCustomStrategyFactory</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCustomStrategyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/moleculer-java/site/edit/master/src/balancing.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/7/2020, 4:13:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/site/serializers.html" class="prev">Serializers</a></span> <span class="next"><a href="/site/fault-tolerance.html">Fault tolerance</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/site/assets/js/app.44cd5f5e.js" defer></script><script src="/site/assets/js/2.b39afa1e.js" defer></script><script src="/site/assets/js/7.2ec3348e.js" defer></script>
  </body>
</html>
