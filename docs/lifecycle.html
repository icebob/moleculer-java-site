<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Broker lifecycle | Moleculer</title>
    <meta name="description" content="Progressive microservices framework for Java">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/site/assets/css/0.styles.75e38820.css" as="style"><link rel="preload" href="/site/assets/js/app.912cc83f.js" as="script"><link rel="preload" href="/site/assets/js/2.3acd50df.js" as="script"><link rel="preload" href="/site/assets/js/13.4e71680b.js" as="script"><link rel="prefetch" href="/site/assets/js/10.2cecf0ec.js"><link rel="prefetch" href="/site/assets/js/11.9545b573.js"><link rel="prefetch" href="/site/assets/js/12.987d4d97.js"><link rel="prefetch" href="/site/assets/js/14.345413ff.js"><link rel="prefetch" href="/site/assets/js/15.dbf77abe.js"><link rel="prefetch" href="/site/assets/js/16.ddcde6dd.js"><link rel="prefetch" href="/site/assets/js/17.44709cf9.js"><link rel="prefetch" href="/site/assets/js/18.2872dc24.js"><link rel="prefetch" href="/site/assets/js/19.75e959ef.js"><link rel="prefetch" href="/site/assets/js/20.eb4d58da.js"><link rel="prefetch" href="/site/assets/js/21.6b73e890.js"><link rel="prefetch" href="/site/assets/js/22.1326cf10.js"><link rel="prefetch" href="/site/assets/js/23.5048399f.js"><link rel="prefetch" href="/site/assets/js/3.1e1471b4.js"><link rel="prefetch" href="/site/assets/js/4.97a990f8.js"><link rel="prefetch" href="/site/assets/js/5.ca18e311.js"><link rel="prefetch" href="/site/assets/js/6.0b93d9b3.js"><link rel="prefetch" href="/site/assets/js/7.6587d446.js"><link rel="prefetch" href="/site/assets/js/8.cb48d30a.js"><link rel="prefetch" href="/site/assets/js/9.24317cce.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.75e38820.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><img src="logo.png" alt="Moleculer" class="logo"> <span class="site-name can-hide">Moleculer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/site/broker.html" class="sidebar-link">Service Broker</a></li><li><a href="/site/services.html" class="sidebar-link">Services</a></li><li><a href="/site/lifecycle.html" class="active sidebar-link">Lifecycle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/lifecycle.html#broker-lifecycle" class="sidebar-link">Broker lifecycle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/lifecycle.html#starting-logic" class="sidebar-link">Starting logic</a></li><li class="sidebar-sub-header"><a href="/site/lifecycle.html#stopping-logic" class="sidebar-link">Stopping logic</a></li></ul></li><li class="sidebar-sub-header"><a href="/site/lifecycle.html#service-lifecycle" class="sidebar-link">Service lifecycle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/lifecycle.html#started-event-handler" class="sidebar-link">started event handler</a></li><li class="sidebar-sub-header"><a href="/site/lifecycle.html#stopped-event-handler" class="sidebar-link">stopped event handler</a></li></ul></li></ul></li><li><a href="/site/actions.html" class="sidebar-link">Actions</a></li><li><a href="/site/middlewares.html" class="sidebar-link">Middlewares</a></li><li><a href="/site/caching.html" class="sidebar-link">Caching</a></li><li><a href="/site/events.html" class="sidebar-link">Events</a></li><li><a href="/site/internal-services.html" class="sidebar-link">Internal Services</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Clustering</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="broker-lifecycle"><a href="#broker-lifecycle" class="header-anchor">#</a> Broker lifecycle</h2> <p>This section describes what happens when the Service Broker starts or stops.</p> <h3 id="starting-logic"><a href="#starting-logic" class="header-anchor">#</a> Starting logic</h3> <p>When the broker starts
<a href="/site/transporters.html">Transporter</a>
to connect to other nodes,
does not yet publish the local service list.
It starts all the Services first (calls the <code>started</code> handler)
and then publishes the service list to the other nodes.
Hence remote nodes send requests only after all local service are started properly.</p> <div class="custom-block warning"><p class="custom-block-title">Avoid deadlocks</p> <p>Dead-locks can be made when two services wait for each other.
For example <code>users</code> service has <code>@Dependencies({&quot;posts&quot;})</code> and <code>posts</code> service has <code>@Dependencies({&quot;users&quot;})</code>.
To avoid it, remove the concerned service from <code>@Dependencies</code> and use
<a href="/site/services.html#wait-for-services-via-servicebroker">waitForServices</a>
method in <code>started</code> handler.</p></div> <h3 id="stopping-logic"><a href="#stopping-logic" class="header-anchor">#</a> Stopping logic</h3> <p>When you call <code>broker.stop</code> or stop the process, at first broker send a <code>DISCONNECT</code> message to remote nodes,
so they can route the requests to other instances instead of services under stopping.
Next, the broker starts stopping all local services. After that, the transporter disconnects.</p> <h2 id="service-lifecycle"><a href="#service-lifecycle" class="header-anchor">#</a> Service lifecycle</h2> <p>This section describes what happens when a service is starting &amp; stopping and how you should use the lifecycle event handler.</p> <h3 id="started-event-handler"><a href="#started-event-handler" class="header-anchor">#</a> <code>started</code> event handler</h3> <p>It is triggered when the <code>broker.start</code> is called and the broker starts all local services.
Use it to connect to database, listen servers...etc.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer</span><span class="token punctuation">.</span><span class="token class-name">ServiceBroker</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer<span class="token punctuation">.</span>cacher</span><span class="token punctuation">.</span><span class="token class-name">Cacher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Object to initialize
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Cacher</span> cacher<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Starting the Service instance...
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">started</span><span class="token punctuation">(</span><span class="token class-name">ServiceBroker</span> broker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Custom initialization code</span>
        cacher <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To register for the above Service at the Service Broker:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServiceBrokerConfig</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setNodeID</span><span class="token punctuation">(</span><span class="token string">&quot;node1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServiceBroker</span> broker <span class="token operator">=</span> <span class="token class-name">ServiceBroker</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">createService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="stopped-event-handler"><a href="#stopped-event-handler" class="header-anchor">#</a> <code>stopped</code> event handler</h3> <p>It is triggered when the <code>broker.stop</code> is called and the broker starts stopping all local services.
Use it to close database connections, stop Executors and Timers, close sockets...etc.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Release resources...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you use Spring, the above <code>started</code> and <code>stopped</code> functions should not be called by Spring as <code>init-method</code> or <code>destroy-method</code>).
These functions are invoked in all cases by the Service Broker, not by the Spring Framework.
However, you can create <code>init</code> / <code>destroy</code> functions for Spring, regardless of the <code>started</code> / <code>stopped</code> functions.
In this case, the start and stop order is as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Controller</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>datatree</span><span class="token punctuation">.</span><span class="token class-name">Tree</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer</span><span class="token punctuation">.</span><span class="token class-name">ServiceBroker</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">services<span class="token punctuation">.</span>moleculer<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token comment">// --- STARTING SERVICE ---</span>
    
    <span class="token keyword">public</span> <span class="token class-name">TestService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1.) The constructor is called first</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">// 2.) This invoked before the &quot;started&quot; method</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">started</span><span class="token punctuation">(</span><span class="token class-name">ServiceBroker</span> broker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>broker<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.) Initialize service...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// --- RUNNING SERVICE ---</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Action</span> action <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// 4.) This Action is called by other Actions</span>
        <span class="token keyword">int</span> foo <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">,</span> foo <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// --- STOPPING SERVICE ---</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 5.) Invoked by the Service Broker</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PreDestroy</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">// 6.) Invoked by Spring after the &quot;stopped&quot; method</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

        <span class="token comment">// 7.) This called last by the Garbage Collector</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/site/services.html" class="prev">Services</a></span> <span class="next"><a href="/site/actions.html">Actions</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/site/assets/js/app.912cc83f.js" defer></script><script src="/site/assets/js/2.3acd50df.js" defer></script><script src="/site/assets/js/13.4e71680b.js" defer></script>
  </body>
</html>
