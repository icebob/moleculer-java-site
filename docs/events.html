<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Events | Moleculer</title>
    <meta name="description" content="Progressive microservices framework for Java">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/site/assets/css/0.styles.75e38820.css" as="style"><link rel="preload" href="/site/assets/js/app.1b245943.js" as="script"><link rel="preload" href="/site/assets/js/2.ee67e98b.js" as="script"><link rel="preload" href="/site/assets/js/10.7f10460c.js" as="script"><link rel="prefetch" href="/site/assets/js/11.c3eb5bb8.js"><link rel="prefetch" href="/site/assets/js/12.e2a7b9e4.js"><link rel="prefetch" href="/site/assets/js/13.f1fcb028.js"><link rel="prefetch" href="/site/assets/js/14.e5365192.js"><link rel="prefetch" href="/site/assets/js/15.b15ac168.js"><link rel="prefetch" href="/site/assets/js/16.f5d9460e.js"><link rel="prefetch" href="/site/assets/js/17.ad4e7f1c.js"><link rel="prefetch" href="/site/assets/js/18.5820bc07.js"><link rel="prefetch" href="/site/assets/js/19.35876ba1.js"><link rel="prefetch" href="/site/assets/js/20.f9220f6a.js"><link rel="prefetch" href="/site/assets/js/21.884c80e4.js"><link rel="prefetch" href="/site/assets/js/22.df72484a.js"><link rel="prefetch" href="/site/assets/js/23.5048399f.js"><link rel="prefetch" href="/site/assets/js/3.cd761dc5.js"><link rel="prefetch" href="/site/assets/js/4.a02ade56.js"><link rel="prefetch" href="/site/assets/js/5.cfca0638.js"><link rel="prefetch" href="/site/assets/js/6.a76f489d.js"><link rel="prefetch" href="/site/assets/js/7.9a81b439.js"><link rel="prefetch" href="/site/assets/js/8.5ebaa4ee.js"><link rel="prefetch" href="/site/assets/js/9.29687fe6.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.75e38820.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><img src="logo.png" alt="Moleculer" class="logo"> <span class="site-name can-hide">Moleculer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/" class="nav-link">Home</a></div><div class="nav-item"><a href="/site/introduction.html" class="nav-link">Documentation</a></div> <a href="https://github.com/moleculer-java/moleculer-java" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/site/broker.html" class="sidebar-link">Service Broker</a></li><li><a href="/site/services.html" class="sidebar-link">Services</a></li><li><a href="/site/lifecycle.html" class="sidebar-link">Lifecycle</a></li><li><a href="/site/actions.html" class="sidebar-link">Actions</a></li><li><a href="/site/middlewares.html" class="sidebar-link">Middlewares</a></li><li><a href="/site/caching.html" class="sidebar-link">Caching</a></li><li><a href="/site/events.html" class="active sidebar-link">Events</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/events.html#emit-balanced-events" class="sidebar-link">Emit balanced events</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/site/events.html#simplified-syntax-for-sending-key-value-pairs" class="sidebar-link">Simplified syntax for sending key-value pairs</a></li><li class="sidebar-sub-header"><a href="/site/events.html#streaming-binary-files" class="sidebar-link">Streaming binary files</a></li></ul></li><li class="sidebar-sub-header"><a href="/site/events.html#local-broadcast-event" class="sidebar-link">Local broadcast event</a></li><li class="sidebar-sub-header"><a href="/site/events.html#services-changed" class="sidebar-link">$services.changed</a></li><li class="sidebar-sub-header"><a href="/site/events.html#node-connected" class="sidebar-link">$node.connected</a></li><li class="sidebar-sub-header"><a href="/site/events.html#node-updated" class="sidebar-link">$node.updated</a></li><li class="sidebar-sub-header"><a href="/site/events.html#node-disconnected" class="sidebar-link">$node.disconnected</a></li><li class="sidebar-sub-header"><a href="/site/events.html#broker-started" class="sidebar-link">$broker.started</a></li><li class="sidebar-sub-header"><a href="/site/events.html#broker-stopped" class="sidebar-link">$broker.stopped</a></li><li class="sidebar-sub-header"><a href="/site/events.html#transporter-connected" class="sidebar-link">$transporter.connected</a></li><li class="sidebar-sub-header"><a href="/site/events.html#transporter-disconnected" class="sidebar-link">$transporter.disconnected</a></li></ul></li><li><a href="/site/internal-services.html" class="sidebar-link">Internal Services</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Clustering</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Molculer Service Broker has a built-in event bus for sending events to local and remote services.
Events can be used to create event-driven,
runtime scalable applications from services
deployed on different operating systems and implemented in different languages.</p> <p>Events can be grouped; events can be sent to</p> <ul><li>a specific node</li> <li>to all listeners</li> <li>to a group of listeners</li> <li>or to one member from all groups</li></ul> <h1 id="balanced-events"><a href="#balanced-events" class="header-anchor">#</a> Balanced events</h1> <p>The event listeners are arranged to logical groups.
It means that only one listener is triggered in every group.</p> <blockquote><p><strong>Example:</strong> An application contains 2 main services: <code>users</code> &amp; <code>payments</code>.
Both subscribe to the <code>user.created</code> event.
3 instances of <code>users</code> service and 2 instances of <code>payments</code> service run.
If the <code>user.created</code> event is emitted, only one <code>users</code> and one <code>payments</code> service will receive this event.</p></blockquote> <div align="center"><img src="balanced-events.gif" alt="Balanced events diagram"></div> <p>The group name comes from the service name, but it can be overwritten in event definition in services
(by the <code>@Group</code> Annotation).</p> <p><strong>Example:</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;order.created&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Group</span><span class="token punctuation">(</span><span class="token string">&quot;other&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Listener</span> orderCreated <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Payload:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sender:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>nodeID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Metadata:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The called event name:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Example of parsing the &quot;params&quot; block:</span>
        <span class="token class-name">String</span> firstName <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;defaultValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> lastName  <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;lastName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="emit-balanced-events"><a href="#emit-balanced-events" class="header-anchor">#</a> Emit balanced events</h2> <p>Send balanced events with <code>broker.emit</code> function.
The first parameter is the name of the event, the second parameter is the payload.
<em>To send multiple/hierarchical values, wrap them into a <code>Tree</code> object.</em></p> <p>Moleculer does not require a recommended JSON API, it uses an
<a href="https://berkesa.github.io/datatree/" target="_blank" rel="noopener noreferrer">abstract API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
instead of a certain implementation.
The <code>Tree</code> object is an <strong>abstract layer</strong> that uses an arbitrary JSON implementation.
Tree API supports 18 popular JSON implementations (eg. Jackson, Gson, Boon, Jodd, FastJson),
and 10 non-JSON data formats (YAML, ION, BSON, MessagePack, etc.).
Besides that Tree API adds manipulation capabilities to the underlaying JSON API,
such as sorting, filtering, merging, cloning, or changing data types.
The specific JSON (or non-JSON) implementation can be configured
in the Moleculer configuration (see in section &quot;Serializer&quot;).
Regardless of implementation, sending events looks like this:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// The &quot;user&quot; is a &quot;Tree&quot; object (~=JSON structure)</span>
<span class="token comment">// that will be serialized for transport.</span>
<span class="token class-name">Tree</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lastName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Doe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Emit event</span>
broker<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Specify which groups/services shall receive the event:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Only the &quot;mail&quot; &amp; &quot;payments&quot; services receive this event</span>
broker<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token class-name">Groups</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;mail&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;payments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="simplified-syntax-for-sending-key-value-pairs"><a href="#simplified-syntax-for-sending-key-value-pairs" class="header-anchor">#</a> Simplified syntax for sending key-value pairs</h3> <p>If the data structure to be sent consists only of key-value pairs,
it is not necessary to create a <code>Tree</code> object.
It is enough to list the key-value pairs after the event name:</p> <div class="language-java extra-class"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span>
         <span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
         <span class="token string">&quot;lastName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Doe&quot;</span><span class="token punctuation">,</span>
         <span class="token class-name">Groups</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;mail&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;payments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Creating a Tree object is required when passing more complex data structures between Nodes,
which contain sub-structures (~=hierarchical JSON objects and JSON arrays).</p> <h3 id="streaming-binary-files"><a href="#streaming-binary-files" class="header-anchor">#</a> Streaming binary files</h3> <p>In addition to JSON structures, it is possible to send large files
and/or media content (videos, audio).</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Opening stream</span>
<span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;service.listener&quot;</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Sending file...</span>
stream<span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;source.bin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// File submitted</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Unexpected error occurred</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It is possible to send data immediately if we are not sending data from a file
(for example, transmitting a microphone signal).</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Opening stream</span>
<span class="token class-name">PacketStream</span> stream <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
broker<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;service.listener&quot;</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Sending packets</span>
stream<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">&quot;packet1&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">&quot;packet2&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">&quot;packet3&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Streams must be closed!</span>
stream<span class="token punctuation">.</span><span class="token function">sendClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="broadcast-event"><a href="#broadcast-event" class="header-anchor">#</a> Broadcast event</h1> <p>The broadcast event is sent to all available local &amp; remote services.
It is not balanced, all event listener instances receive this event.</p> <div align="center"><img src="broadcast-events.gif" alt="Broadcast events diagram"></div> <p>Send broadcast events with <code>broker.broadcast</code> method.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// The &quot;config&quot; is a hierarchical (~=JSON) structure</span>
<span class="token class-name">Tree</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">putList</span><span class="token punctuation">(</span><span class="token string">&quot;anArray&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">putMap</span><span class="token punctuation">(</span><span class="token string">&quot;anObject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send &quot;config&quot; to all listeners</span>
broker<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token string">&quot;config.changed&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Specify which groups/services shall receive the event:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Send to all &quot;mail&quot; service instances</span>
broker<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token class-name">Groups</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;mail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send to all &quot;user&quot; &amp; &quot;purchase&quot; service instances.</span>
broker<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token class-name">Groups</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;purchase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Same thing, but with simplified syntax</span>
ctx<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;lastName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Doe&quot;</span><span class="token punctuation">,</span>
              <span class="token class-name">Groups</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;purchase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="local-broadcast-event"><a href="#local-broadcast-event" class="header-anchor">#</a> Local broadcast event</h2> <p>Send broadcast events only to all local services with <code>broker.broadcastLocal</code> method.</p> <div class="language-java extra-class"><pre class="language-java"><code>broker<span class="token punctuation">.</span><span class="token function">broadcastLocal</span><span class="token punctuation">(</span><span class="token string">&quot;config.changed&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="subscribe-to-events"><a href="#subscribe-to-events" class="header-anchor">#</a> Subscribe to events</h1> <p>The contents of the events are wrapped in an object called Event Context to receive the message.
The Event Context is very similar to Action Context.</p> <p><strong>Context-based event handler &amp; emit a nested event</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Name</span><span class="token punctuation">(</span><span class="token string">&quot;accounts&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Listener</span> userCreated <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Payload:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sender:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>nodeID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Metadata:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The called event name:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Emit a new, nested Event</span>
        <span class="token class-name">Tree</span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payload<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;accounts.created&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>Wildcards</strong></p> <p>Wildcards (<code>?</code>, <code>*</code>, <code>**</code>) can be used when making event subscriptions.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>

    <span class="token comment">// Subscribe to &quot;user.created&quot; event</span>
    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;user.created&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Listener</span> userCreated <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User created event received:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Subscribe to all &quot;user&quot; events</span>
    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;user.*&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Listener</span> userEvents <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User event event received:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
    <span class="token comment">// Subscribe to all internal events</span>
    <span class="token comment">// (internal event names start with &quot;$&quot; prefix)</span>
    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;$**&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Listener</span> internalEvents <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Event &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot; received:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Invisible (private or internal) Event Listeners</strong></p> <p>With the &quot;private&quot; modifier, only the local events are monitored by the Event Listener.
Such Event Listeners are invisible from the outside of the Node,
and cannot be called from other Service Brokers.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;$services.changed&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Listener</span> listener <span class="token operator">=</span> ctx <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The list of services has changed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Redirecting streamed content</strong></p> <p>Stream data can be redirected to a File, ByteChannel or OutputStream.</p> <div class="language-java extra-class"><pre class="language-java"><code>ctx<span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;/temp.bin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rsp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// File received and saved successfully</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Unexpected error occurred</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Processing streamed content</strong></p> <p>Stream data can also be processed per packet.</p> <div class="language-java extra-class"><pre class="language-java"><code>ctx<span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">onPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> error<span class="token punctuation">,</span> closed<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// A byte-array has arrived</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Error occurred</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Incoming stream closed (EOF)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="context"><a href="#context" class="header-anchor">#</a> Context</h1> <p>When you emit an event, the broker creates a <code>Context</code> instance which contains all
request information and passes it to the event handler as a single argument.</p> <p><strong>Available properties &amp; methods of <code>Context</code>:</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>ctx.id</code></td> <td><code>String</code></td> <td>Unique Context ID.</td></tr> <tr><td><code>ctx.name</code></td> <td><code>String</code></td> <td>Name of the event.</td></tr> <tr><td><code>ctx.params</code></td> <td><code>Tree</code></td> <td>Request params. Contains meta-data (<code>ctx.params.getMeta()</code>).</td></tr> <tr><td><code>ctx.level</code></td> <td><code>int</code></td> <td>Request level (in nested-calls). The first level is <code>1</code>.</td></tr> <tr><td><code>ctx.nodeID</code></td> <td><code>String</code></td> <td>The caller or target Node ID.</td></tr> <tr><td><code>ctx.parentID</code></td> <td><code>String</code></td> <td>Parent context ID (in nested-calls).</td></tr> <tr><td><code>ctx.requestID</code></td> <td><code>String</code></td> <td>Request ID (does not change during the call chain).</td></tr> <tr><td><code>ctx.stream</code></td> <td><code>PacketStream</code></td> <td>Streamed content (large files or real-time media).</td></tr> <tr><td><code>ctx.opts</code></td> <td><code>Options</code></td> <td>Calling options.</td></tr> <tr><td><code>ctx.call()</code></td> <td><code>Method</code></td> <td>Make nested-calls. Same arguments like in <code>broker.call</code></td></tr> <tr><td><code>ctx.emit()</code></td> <td><code>Method</code></td> <td>Emit an event, same as <code>broker.emit</code></td></tr> <tr><td><code>ctx.broadcast()</code></td> <td><code>Method</code></td> <td>Broadcast an event, same as <code>broker.broadcast</code></td></tr></tbody></table> <h1 id="internal-events"><a href="#internal-events" class="header-anchor">#</a> Internal events</h1> <p>The broker broadcasts some internal events.
Internal events always starts with <code>$</code> prefix.</p> <h2 id="services-changed"><a href="#services-changed" class="header-anchor">#</a> <code>$services.changed</code></h2> <p>The broker sends this event if the local node or a remote node loads or destroys services.</p> <p><strong>Payload</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>localService</code></td> <td><code>boolean</code></td> <td>True if a local service changed.</td></tr></tbody></table> <h2 id="node-connected"><a href="#node-connected" class="header-anchor">#</a> <code>$node.connected</code></h2> <p>The broker sends this event when a node connected or reconnected.</p> <p><strong>Payload</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>node</code></td> <td><code>Tree</code></td> <td>Node info object</td></tr> <tr><td><code>reconnected</code></td> <td><code>boolean</code></td> <td>Is reconnected?</td></tr></tbody></table> <h2 id="node-updated"><a href="#node-updated" class="header-anchor">#</a> <code>$node.updated</code></h2> <p>The broker sends this event when it has received an INFO message from a node
(ie. a service is loaded or destroyed).</p> <p><strong>Payload</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>node</code></td> <td><code>Tree</code></td> <td>Node info object</td></tr></tbody></table> <h2 id="node-disconnected"><a href="#node-disconnected" class="header-anchor">#</a> <code>$node.disconnected</code></h2> <p>The broker sends this event when a node disconnected (gracefully or unexpectedly).</p> <p><strong>Payload</strong></p> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>node</code></td> <td><code>Tree</code></td> <td>Node info object</td></tr> <tr><td><code>unexpected</code></td> <td><code>boolean</code></td> <td><code>true</code> - Not received heartbeat, <code>false</code> - Received <code>DISCONNECT</code> message from node.</td></tr></tbody></table> <h2 id="broker-started"><a href="#broker-started" class="header-anchor">#</a> <code>$broker.started</code></h2> <p>The broker sends this event once <code>broker.start()</code> is called and all local services are started.</p> <h2 id="broker-stopped"><a href="#broker-stopped" class="header-anchor">#</a> <code>$broker.stopped</code></h2> <p>The broker sends this event once <code>broker.stop()</code> is called and all local services are stopped.</p> <h2 id="transporter-connected"><a href="#transporter-connected" class="header-anchor">#</a> <code>$transporter.connected</code></h2> <p>The transporter sends this event once the transporter is connected.</p> <h2 id="transporter-disconnected"><a href="#transporter-disconnected" class="header-anchor">#</a> <code>$transporter.disconnected</code></h2> <p>The transporter sends this event once the transporter is disconnected.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/site/caching.html" class="prev">Caching</a></span> <span class="next"><a href="/site/internal-services.html">Internal Services</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/site/assets/js/app.1b245943.js" defer></script><script src="/site/assets/js/2.ee67e98b.js" defer></script><script src="/site/assets/js/10.7f10460c.js" defer></script>
  </body>
</html>
